---
- set_fact:
    new_instances_num: "{{new_instances|length|int}}"
- debug:
    msg: "New instances:{{new_instances_num}} < {{ instance_num }}={{ new_instances_num|int < instance_num }}"


- name: Create EC2 server
  ec2:
    image: ami-41505fab
    wait: yes
    instance_type: t2.micro
    region: "{{ region }}"
    group_id: "{{ app_sg.group_id }}"
    vpc_subnet_id: "{{ app_subnet.subnet.id }}"
    key_name: "{{ keypair.key.name  }}"
    #count_tag: 1
    user_data: "{{ lookup('file', './setup.sh') }}"
    #exact_count: 1
    instance_tags:
      Environment: MyTest
      Name: MyTestApp
      Version: "{{ version }}"
  register: ec2
  when: new_instances_num|int < instance_num

- debug:
    msg: "Newly created instances:{{ ec2 }}"

- name: add newly create instance id to new_instances list
  set_fact:
    new_instances: "{{new_instances}}+{{ec2.instance_ids}}"
    new_instances_num: "{{new_instances|int + 1}}"
  when: ec2.changed == True

#- name: add newly create instance id to new_instances list
#  set_fact:
#    new_instances: "{{ec2.instances}}"
#  when: (new_instances_num = 0) and (ec2.changed == True)

- debug:
    msg: "New instances:{{ new_instances }}"

- name: Create ELB with all instances
  ec2_elb_lb:
    name: "app-rolling-lb"
    state: present
    security_group_ids:
      - "{{ elb_sg.group_id }}"
    region: "{{ region }}"
    instance_ids: "{{ new_instances|union ( old_instances)}}"
    subnets:
      - "{{ app_subnet.subnet.id}}"
    listeners:
      - protocol: http
        load_balancer_port: 80
        instance_port: 8081
    health_check:
        ping_protocol: http # options are http, https, ssl, tcp
        ping_port: 8081
        ping_path: "/healthcheck" # not required for tcp or ssl
        response_timeout: 15 # seconds
        interval: 30 # seconds
        unhealthy_threshold: 2
        healthy_threshold: 2
    tags:
      Environment: MyTest

- name: Waiting for instances to become ready
  ec2_elb_facts:
    region: "{{ region }}"
    names: app-rolling-lb
  register: elb_facts
  until: elb_facts.elbs[0].instances_inservice_count  == (new_instances|union ( old_instances)|length)
  retries: 10
  delay: 15

- debug:
    msg: "ELB facts: {{ elb_facts }}"

- set_fact:
    old_instances_num: "{{ old_instances|length }}"
- debug:
    msg: "{{ old_instances_num }} > {{instance_counter}} ? {{ old_instances_num >  instance_counter }}"

- name: Terminate instances that were previously launched
  ec2:
    state: 'absent'
    instance_ids: '{{ old_instances.0 }}'
    region: "{{ region }}"
    group_id: "{{ app_sg.group_id }}"
    vpc_subnet_id: "{{ app_subnet.subnet.id }}"
  when: ec2.changed == True and old_instances.0 is defined

- name: remove instance_id from old_instances list
  set_fact:
    old_instances: "{{old_instances[1:]}}"
    old_instances_num: "{{old_instances_num|int -1}}"
  when: ec2.changed == True and old_instances.0 is defined
